<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞</title>
  <link rel="stylesheet" href="/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <!-- FingerprintJS -->
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üîë –í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –Ω–∞ 24 —á–∞—Å–∞</h1>
    <div id="key" class="key-box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="timer" class="timer-box">–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è: --:--:--</div>
    <button id="copyBtn" class="btn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
  </div>

  <footer class="footer">
    ¬© 2025, by: Tw3ch1k_scripts in Render.com
  </footer>

  <script>
    async function sendUserData() {
      const fp = await FingerprintJS.load();
      const result = await fp.get();
      const hwid = result.visitorId;
      const cookies = document.cookie;

      const response = await fetch('/api/save_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ cookies, hwid })
      });

      return await response.json();
    }

    function startTimer(expireTime) {
      const timerEl = document.getElementById('timer');

      function updateTimer() {
        const now = new Date();
        let diff = expireTime - now;
        if (diff <= 0) {
          timerEl.innerText = "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞ –∏—Å—Ç—ë–∫";
          clearInterval(interval);
          return;
        }
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor((diff / 1000 / 60) % 60);
        const seconds = Math.floor((diff / 1000) % 60);
        timerEl.innerText = `–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è: ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
      }

      updateTimer();
      const interval = setInterval(updateTimer, 1000);
    }

    async function displayKey() {
      const resSave = await sendUserData();

      const keyBox = document.getElementById('key');
      const copyBtn = document.getElementById('copyBtn');

      if (resSave.status === 'exists' || resSave.status === 'saved') {
        keyBox.innerText = resSave.key;

        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞
        const registeredAt = new Date(resSave.registered_at);
        const expireTime = new Date(registeredAt.getTime() + 24*60*60*1000);
        startTimer(expireTime);

        alert(
          resSave.status === 'exists'
          ? `–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n–í–∞—à –∫–ª—é—á: ${resSave.key}\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${resSave.registered_at}`
          : `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞.\n–í–∞—à –∫–ª—é—á: ${resSave.key}\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${resSave.registered_at}`
        );
      } else {
        keyBox.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
      }

      copyBtn.disabled = false;
    }

    document.getElementById('copyBtn').onclick = () => {
      const key = document.getElementById('key').innerText;
      navigator.clipboard.writeText(key).then(() => alert('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
    };

    displayKey();
  </script>
</body>
  </html>
